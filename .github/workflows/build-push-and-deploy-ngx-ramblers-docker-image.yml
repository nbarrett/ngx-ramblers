name: Deploy and Build Docker Image and Deploy to Fly.io

on:
  push:
    branches: [ "main", "pre-main" ]
  pull_request:
    branches: [ "main" ]

env:
  NODE_VERSION: '22.19.0'
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install root dependencies
        run: npm ci

      - name: Install server dependencies
        run: npm ci
        working-directory: ./server

      - name: Setup Chrome for headless tests
        uses: browser-actions/setup-chrome@v1

      - name: Export CHROME_BIN for Karma
        run: echo "CHROME_BIN=$CHROME_PATH" >> $GITHUB_ENV

      - name: Set timezone for tests
        run: echo "TZ=Europe/London" >> $GITHUB_ENV

      - name: Run frontend unit tests (headless)
        run: npm run test

      - name: Run server unit tests
        run: npm run test:server

  deploy:
    needs: test
    runs-on: ubuntu-latest
    concurrency:
      group: deploy-group
      cancel-in-progress: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install root dependencies
        run: npm ci

      - name: Install server dependencies
        run: npm ci
        working-directory: ./server

      - name: Create configs directory
        run: mkdir -p non-vcs/fly-io

      - name: Create configs.json from secrets
        env:
          CONFIGS_JSON: ${{ secrets.CONFIGS_JSON }}
        run: |
          echo "$CONFIGS_JSON" > non-vcs/fly-io/configs.json

      - name: Install ts-node
        run: npm install -g ts-node

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build the Docker image
        run: docker build . --build-arg CHROME_VERSION=${{ secrets.CHROME_VERSION }} --file Dockerfile --tag ngx-ramblers:${{ github.run_number }}

      - name: Tag the Docker image (latest)
        if: github.ref_name == 'main'
        run: docker tag ngx-ramblers:${{ github.run_number }} ${{ secrets.DOCKER_USERNAME }}/ngx-ramblers:latest

      - name: Push the Docker image to Docker Hub (latest)
        if: github.ref_name == 'main'
        run: docker push ${{ secrets.DOCKER_USERNAME }}/ngx-ramblers:latest

      - name: Tag the Docker image (github run number ${{ github.run_number }})
        run: docker tag ngx-ramblers:${{ github.run_number }} ${{ secrets.DOCKER_USERNAME }}/ngx-ramblers:${{ github.run_number }}

      - name: Push the Docker image to Docker Hub (github run number ${{ github.run_number }})
        run: docker push ${{ secrets.DOCKER_USERNAME }}/ngx-ramblers:${{ github.run_number }}

      - name: Install Flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy image ngx-ramblers:${{ github.run_number }} to fly.io
        timeout-minutes: 15
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
          ADMIN_MONGODB_URI: ${{ secrets.ADMIN_MONGODB_URI }}
        run: |
          ts-node server/deploy/deploy-to-environments.ts --environment "${{ secrets.APP_NAME }}" --image-tag "${{ github.run_number }}"

      - name: Generate Release Notes
        if: github.ref_name == 'main' && github.event_name == 'push'
        env:
          CMS_USERNAME: ${{ secrets.CMS_USERNAME }}
          CMS_PASSWORD: ${{ secrets.CMS_PASSWORD }}
        run: |
          cd server
          npm run release-notes -- --latest --build-number ${{ github.run_number }} --include-unassigned

      - name: Cleanup sensitive files
        if: always()
        run: rm -f non-vcs/fly-io/configs.json
